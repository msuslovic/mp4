---
title: "MP4"
author: "Meghan Suslovic & Yifan Ma"
date: "5/3/2018"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Female directors, writers, and producers
Source: IMDB
name table: has gender
info_type: runtime, genres
kind_type: movie=1
role_type: director=8, producer=3, 

join role_type with cast_info based on 

SELECT ci. person_id, ci. movie_id, ci. role_id
FROM cast_info ci
JOIN role_type rt
ON ci. role_id = rt .id
WHERE rt.id = 8
;


Context:
http://www.denofgeek.com/us/movies/female-directors/252810/26-female-directors-you-should-know-about-and-why-you-might-not 


-find percentage of female directors of feature length movies 
-is there a genre of movie that women direct in higher percentages
-how do the ratings differ
-are there more females working in a particular country (in info table)?
-how does their budget compare to movies with male directors?
-are females directing in higher ratios in independent films vs studio ones?


```{r}
library(mdsr)
library(tidyverse)
library(RMySQL)
db <- dbConnect_scidb(dbname = "imdb")
```

### Directors

```{r}
directors <- db %>%
  dbGetQuery("SELECT n. gender, mi. movie_id,t. Production_year, mi. info
FROM cast_info ci
JOIN role_type rt
ON ci. role_id = rt .id
JOIN name n
ON n.id =  ci. person_id
JOIN movie_info mi ON mi. movie_id = ci. movie_id
JOIN info_type it ON mi. Info_type_id = it.id
JOIN title t ON t.id  = ci. movie_id
JOIN kind_type kt ON kt. id = t. kind_id 
WHERE rt.id = 8 AND t. kind_id = 1 AND info_type_id = 1
HAVING info > 40
")

head(directors)

directors <- directors %>%
  filter (Production_year != 2018,Production_year != 2021, Production_year != 2024, Production_year != 2019, Production_year != 2020, !is.na(gender))
  

d_sum <- directors %>%
  group_by(Production_year) %>%
  summarise(sum_n = n())

d_timeline <- directors %>%
  filter(gender == "f") %>%
  group_by(Production_year) %>%
  summarise(f = n()) %>%
  left_join (d_sum, by ="Production_year") %>%
  mutate(p = f/sum_n*100)
  
d <- d_timeline %>%
  ggplot(aes( x = Production_year, y = p))+
  geom_line()
  
t_total <- d_timeline %>%
  ggplot(aes( x = Production_year, y = sum_n))+
  geom_line()

d
t_total  
```

### Writers

```{r}
writer <- db %>%
  dbGetQuery("SELECT n. gender, mi. movie_id,t. Production_year, mi. info
FROM cast_info ci
JOIN role_type rt
ON ci. role_id = rt .id
JOIN name n
ON n.id =  ci. person_id
JOIN movie_info mi ON mi. movie_id = ci. movie_id
JOIN info_type it ON mi. Info_type_id = it.id
JOIN title t ON t.id  = ci. movie_id
JOIN kind_type kt ON kt. id = t. kind_id 
WHERE rt.id = 3 AND t. kind_id = 1 AND info_type_id = 1
HAVING info > 40
")

head(writer)

writer <- writer %>%
  filter (Production_year != 2018, Production_year != 2024, Production_year != 2019, Production_year != 2020, !is.na(gender))
  

w_sum <- writer %>%
  group_by(Production_year) %>%
  summarise(sum_n = n())

w_timeline <- writer %>%
  filter(gender == "f") %>%
  group_by(Production_year) %>%
  summarise(f = n()) %>%
  left_join (w_sum, by ="Production_year") %>%
  mutate(p = f/sum_n*100)
  
w <- w_timeline %>%
  ggplot(aes( x = Production_year, y = p))+
  geom_line()
  
w_total <- w_timeline %>%
  ggplot(aes( x = Production_year, y = sum_n))+
  geom_line()

w
w_total  
```

###Producers

```{r}
producers <- db %>%
  dbGetQuery("SELECT n. gender, mi. movie_id,t. Production_year, mi. info
FROM cast_info ci
JOIN role_type rt
ON ci. role_id = rt .id
JOIN name n
ON n.id =  ci. person_id
JOIN movie_info mi ON mi. movie_id = ci. movie_id
JOIN info_type it ON mi. Info_type_id = it.id
JOIN title t ON t.id  = ci. movie_id
JOIN kind_type kt ON kt. id = t. kind_id 
WHERE rt.id = 4 AND t. kind_id = 1 AND info_type_id = 1
HAVING info > 40
")

head(producers)

#producers <- producers %>%
  #filter (Production_year != 2018,Production_year != 2021, Production_year != 2024, Production_year != 2019, Production_year != 2020, !is.na(gender))
  

p_sum <- producers %>%
  group_by(Production_year) %>%
  summarise(sum_n = n())

p_timeline <- producers %>%
  filter(gender == "f") %>%
  group_by(Production_year) %>%
  summarise(f = n()) %>%
  left_join (p_sum, by ="Production_year") %>%
  mutate(p = f/sum_n*100)
  
p <- w_producers %>%
  ggplot(aes(x = Production_year, y = p))+
  geom_line()
  
p_total <- p_timeline %>%
  ggplot(aes( x = Production_year, y = sum_n))+
  geom_line()

p
p_total  
```

```{r}
genre <- db %>%
  dbGetQuery("SELECT n. gender, t. Production_year, mi.info
FROM cast_info ci
JOIN role_type rt
ON ci. role_id = rt .id
JOIN name n
ON n.id =  ci. person_id
JOIN movie_info mi ON mi. movie_id = ci. movie_id
JOIN info_type it ON mi. Info_type_id = it.id
JOIN title t ON t.id  = ci. movie_id
JOIN kind_type kt ON kt. id = t. kind_id 
WHERE  rt.id = 8 AND t. kind_id = 1 AND info_type_id = 3
")

```

```{r}
genre <- genre %>%
  select(gender, info) %>%
  filter (!is.na(gender), !is.na(info))

g_sum <- genre %>%
  group_by(info) %>%
  summarise(S = n())

genre_w <-genre %>%
  group_by(info) %>%
  summarise(f = sum(gender == "f"), m = sum(gender == "m"))%>%
  left_join(g_sum, by = "info") %>%
  mutate (f_w = f/S*100, m_w = m/S*100)
  

top_5f <- genre_w %>%
  arrange (desc(f_w)) %>%
  head(10) %>%
  ggplot(aes(x = info, y = f_w))+
  geom_bar(stat = "identity")


top_5f

top_5m <- genre_w %>%
  arrange (desc(m_w)) %>%
  head(10)%>%
  ggplot(aes(x = info, y = m_w))+
  geom_bar(stat = "identity")

top_5m

Sum <-g_sum %>%
  head(10)%>%
  ggplot(aes (x = info, y = S)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x= element_text(angle=45)) +
  labs(title= "Number of Movies Produced in Each Genre", x = "Genre",  y = "Number of Movies", caption = "Source: IMDB")



ptop_5 <- genre_w %>%
  arrange (desc(p_w)) %>%
  head(5) %>%
  ggplot(aes (x = info, y = p_w))+
  geom_bar(stat = "identity")

ptop_5
```

