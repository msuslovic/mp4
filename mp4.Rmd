---
title: "MP4"
author: "Meghan Suslovic & Yifan Ma"
date: "5/3/2018"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Female directors, writers, and producers
Source: IMDB
name table: has gender
info_type: runtime, genres
kind_type: movie=1
role_type: director=8, producer=3, 

join role_type with cast_info based on 

SELECT ci. person_id, ci. movie_id, ci. role_id
FROM cast_info ci
JOIN role_type rt
ON ci. role_id = rt .id
WHERE rt.id = 8
;


Context:
http://www.denofgeek.com/us/movies/female-directors/252810/26-female-directors-you-should-know-about-and-why-you-might-not 


-find percentage of female directors of feature length movies 
-is there a genre of movie that women direct in higher percentages
-how do the ratings differ
-are there more females working in a particular country (in info table)?
-how does their budget compare to movies with male directors?
-are females directing in higher ratios in independent films vs studio ones?


```{r}
library(mdsr)
library(tidyverse)
library(ggplot2)
library(RMySQL)
db <- dbConnect_scidb(dbname = "imdb")
```

### Directors

```{r}
directors <- db %>%
  dbGetQuery("SELECT n. gender, mi. movie_id,t. Production_year, mi. info
FROM cast_info ci
JOIN role_type rt
ON ci. role_id = rt .id
JOIN name n
ON n.id =  ci. person_id
JOIN movie_info mi ON mi. movie_id = ci. movie_id
JOIN info_type it ON mi. Info_type_id = it.id
JOIN title t ON t.id  = ci. movie_id
JOIN kind_type kt ON kt. id = t. kind_id 
WHERE rt.id = 8 AND t. kind_id = 1 AND (info_type_id = 1 OR info
HAVING info > 40
")

head(directors)

directors <- directors %>%
  filter (Production_year != 2018,Production_year != 2021, Production_year != 2024, Production_year != 2019, Production_year != 2020, !is.na(gender))
  

d_sum <- directors %>%
  group_by(Production_year) %>%
  summarise(sum_n = n())

d_timeline <- directors %>%
  filter(gender == "f") %>%
  group_by(Production_year) %>%
  summarise(f = n()) %>%
  left_join (d_sum, by ="Production_year") %>%
  mutate(p = f/sum_n*100)
  
d <- d_timeline %>%
  ggplot(aes( x = Production_year, y = p))+
  geom_line()+
  labs(title= "Percent of Female Directors (1911-2017) ", x = "Year of Production",  y = "Percent of Female Directors", caption = "Source: IMDB")+
  theme_linedraw()
  
t_total <- d_timeline %>%
  ggplot(aes( x = Production_year, y = sum_n))+
  geom_line()+
  labs(title= "Total Number of Directors (1911-2017) ", x = "Year of Production",  y = "Number of Directors", caption = "Source: IMDB")+
  theme_linedraw()

d
t_total  
```

### Directors by country

```{r}
directors_c <- db %>%
  dbGetQuery("SELECT n. gender, mi. movie_id,t. Production_year, mi. info
FROM cast_info ci
JOIN role_type rt
ON ci. role_id = rt .id
JOIN name n
ON n.id =  ci. person_id
JOIN movie_info mi ON mi. movie_id = ci. movie_id
JOIN info_type it ON mi. Info_type_id = it.id
JOIN title t ON t.id  = ci. movie_id
JOIN kind_type kt ON kt. id = t. kind_id 
WHERE rt.id = 8 AND t. kind_id = 1 AND  info_type_id = 8
") 

directors_c <- directors_c %>%
  filter (!is.na(gender), !is.na(Production_year), !is.na(info)) %>%
  right_join(directors, by = "movie_id")
  
directors_usa <- directors_c %>%
  filter (info.x == "USA") %>%
  select(gender.x, Production_year.x, info.x) %>%
  group_by(Production_year.x) %>%
  summarise(S = n())

du <- directors_usaf %>%
  ggplot(aes(x = Production_year.x, y = S)) +
  geom_line()+
  labs(title= "Total Number of Directors in the United States (1913-2017) ", x = "Year of Production",  y = "Number of Directors", caption = "Source: IMDB")+
  theme_linedraw()
  
directors_usaf <- directors_c %>%
  filter (info.x == "USA", gender.x == "f") %>%
  select(gender.x, Production_year.x, info.x) %>%
  group_by(Production_year.x) %>%
  summarise(f = n()) %>%
  left_join (directors_usa, by ="Production_year.x") %>%
  mutate(p = f/S*100)

duf <- directors_usaf %>%
  ggplot(aes(x = Production_year.x, y = p)) +
  geom_line()+
  labs(title= "Percent of Female Directors in the United States (1913-2017) ", x = "Year of Production",  y = "Percent of Female Directors", caption = "Source: IMDB")+
  theme_linedraw()

  
directors_o <- directors_c %>%
  filter(info.x != "USA" ) %>%
  select(gender.x, Production_year.x, info.x) %>%
  group_by(Production_year.x) %>%
  summarise(S = n()) 
  
do <- directors_of %>%
  ggplot(aes(x = Production_year.x, y = S)) +
  geom_line()+
  labs(title= "Total Number of Directors in the Rest of the World (1911-2017) ", x = "Year of Production",  y = "Number of Directors", caption = "Source: IMDB")+
  theme_linedraw()

directors_of <- directors_c %>%
  filter(info.x != "USA", gender.x == "f" ) %>%
  select(gender.x, Production_year.x, info.x) %>%
  group_by(Production_year.x) %>%
  summarise(f = n()) %>%
  left_join (directors_o, by = "Production_year.x") %>%
  mutate(p = f/S*100)

dof <- directors_of%>%
  ggplot(aes(x = Production_year.x, y = p))+
  geom_line()+
  labs(title= "Percent of Female Directors in the Rest of the World (1911-2017) ", x = "Year of Production",  y = "Percent of Female Directors", caption = "Source: IMDB")+
  theme_linedraw()

do
dof
du
duf

```

### Writers

```{r}
writer <- db %>%
  dbGetQuery("SELECT n. gender, mi. movie_id,t. Production_year, mi. info
FROM cast_info ci
JOIN role_type rt
ON ci. role_id = rt .id
JOIN name n
ON n.id =  ci. person_id
JOIN movie_info mi ON mi. movie_id = ci. movie_id
JOIN info_type it ON mi. Info_type_id = it.id
JOIN title t ON t.id  = ci. movie_id
JOIN kind_type kt ON kt. id = t. kind_id 
WHERE rt.id = 3 AND t. kind_id = 1 AND info_type_id = 1
HAVING info > 40
")

head(writer)

writer <- writer %>%
  filter (Production_year != 2018, Production_year != 2024, Production_year != 2019, Production_year != 2020, !is.na(gender))
  

w_sum <- writer %>%
  group_by(Production_year) %>%
  filter(Production_year != 1906, Production_year != 1908, Production_year != 1910) %>%
  summarise(sum_n = n())

w_timeline <- writer %>%
  filter(gender == "f") %>%
  group_by(Production_year) %>%
  summarise(f = n()) %>%
  left_join (w_sum, by ="Production_year") %>%
  mutate(p = f/sum_n*100)
  
w <- w_timeline %>%
  ggplot(aes( x = Production_year, y = p))+
  geom_line()+
  labs(title= "Percent of Female Writers (1912-2017) ", x = "Year of Production",  y = "Percent of Female Writers", caption = "Source: IMDB")+
  theme_linedraw()
  
w_total <- w_timeline %>%
  ggplot(aes( x = Production_year, y = sum_n))+
  geom_line()+
  labs(title= "Number of All Writers (1912-2017) ", x = "Year of Production",  y = "Number of Writers", caption = "Source: IMDB")+
  theme_linedraw()

w
w_total  
```

###Producers

```{r}
producers <- db %>%
  dbGetQuery("SELECT n. gender, mi. movie_id,t. Production_year, mi. info
FROM cast_info ci
JOIN role_type rt
ON ci. role_id = rt .id
JOIN name n
ON n.id =  ci. person_id
JOIN movie_info mi ON mi. movie_id = ci. movie_id
JOIN info_type it ON mi. Info_type_id = it.id
JOIN title t ON t.id  = ci. movie_id
JOIN kind_type kt ON kt. id = t. kind_id 
WHERE rt.id = 4 AND t. kind_id = 1 AND info_type_id = 1
HAVING info > 40
")

head(producers)

producers <- producers %>%
  filter (Production_year != 2018, Production_year != 2024, Production_year != 2019, Production_year != 2020, !is.na(gender))
  

p_sum <- producers %>%
  filter(Production_year != 1908, Production_year != 1910)%>%
  group_by(Production_year) %>%
  summarise(sum_n = n())

p_timeline <- producers %>%
  filter(gender == "f") %>%
  group_by(Production_year) %>%
  summarise(f = n()) %>%
  left_join (p_sum, by ="Production_year") %>%
  mutate(p = f/sum_n*100)
  
p <- p_timeline %>%
  ggplot(aes(x = Production_year, y = p))+
  geom_line()+
  labs(title= "Percent of Female Producers (1911-2017) ", x = "Year of Production",  y = "Percent of Female Producers", caption = "Source: IMDB")+
  theme_linedraw()
  
p_total <- p_sum %>%
  ggplot(aes( x = Production_year, y = sum_n))+
  geom_line()+
  labs(title= "Number of All Producers (1911-2017) ", x = "Year of Production",  y = "Number of Producers", caption = "Source: IMDB")+
  theme_linedraw()

p
p_total  
```

```{r}
genre <- db %>%
  dbGetQuery("SELECT n. gender, t. Production_year, mi.info
FROM cast_info ci
JOIN role_type rt
ON ci. role_id = rt .id
JOIN name n
ON n.id =  ci. person_id
JOIN movie_info mi ON mi. movie_id = ci. movie_id
JOIN info_type it ON mi. Info_type_id = it.id
JOIN title t ON t.id  = ci. movie_id
JOIN kind_type kt ON kt. id = t. kind_id 
WHERE  rt.id = 8 AND t. kind_id = 1 AND info_type_id = 3
")

```

```{r}
genre <- genre %>%
  select(gender, info) %>%
  filter (!is.na(gender), !is.na(info))

g_sum <- genre %>%
  group_by(info) %>%
  summarise(S = n())

genre_w <-genre %>%
  group_by(info) %>%
  summarise(f = sum(gender == "f"), m = sum(gender == "m"))%>%
  left_join(g_sum, by = "info") %>%
  mutate (f_w = f/S*100, m_w = m/S*100)
  

top_5f <- genre_w %>%
  arrange (desc(f_w)) %>%
  head(10) %>%
  ggplot(aes(x = info, y = f_w))+
  geom_bar(stat = "identity")


top_5f

#top_5m <- genre_w %>%
  arrange (desc(m_w)) %>%
  head(5)%>%
  ggplot(aes(x = info, y = m_w))+
  geom_bar(stat = "identity")+
  labs(title= "Genres That Have the Most Male Directors", x = "Genre",  y = "Percent of Male Directors", caption = "Source: IMDB")+
 theme_linedraw()

Sum <-g_sum %>%
  head(10)%>%
  ggplot(aes (x = info, y = S)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x= element_text(angle=45)) +
  labs(title= "Number of Movies Produced in Each Genre", x = "Genre",  y = "Number of Movies", caption = "Source: IMDB")+
 theme_linedraw()



ptop_5 <- genre_w %>%
  arrange (desc(f_w)) %>%
  head(5) %>%
  ggplot(aes (x = info, y = f_w))+
  geom_bar(stat = "identity")+
  labs(title= "Genres That Have the Most Female Directors", x = "Genre",  y = "Percent of Female Directors ", caption = "Source: IMDB")+
  theme_linedraw()

Sum
ptop_5
```

